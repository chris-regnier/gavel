# Output Formatting & Structured Logging Design

**Date:** 2026-02-17
**Branch:** output-formatting
**Status:** Approved

## Problem

Gavel's `analyze` command dumps a raw JSON verdict to stdout with no format control. SARIF is written to disk but not available as output. Logging is unstructured (`log.Printf`, `fmt.Fprintln`) and mixes with data output. There's no way to get PR-ready markdown or colored terminal output.

## Goals

1. Add `--format` flag with four output formats: `json` (default), `sarif`, `markdown`, `pretty`
2. TTY auto-detection: pretty output when interactive, json when piped — overridable with `--format`
3. GitHub-compliant SARIF output (partialFingerprints, security-severity, precision, invocations)
4. GFM markdown output suitable for PR comments via `gh pr comment -F -`
5. Colored terminal output grouped by file, eslint-style
6. Structured logging via `log/slog` with `--quiet`/`--verbose`/`--debug` flags
7. Clean stdout/stderr separation: data to stdout, diagnostics to stderr

## Non-Goals

- Direct GitHub API integration for posting PR comments (future work)
- SARIF upload action (already exists via `github/codeql-action/upload-sarif`)
- Changes to the review TUI

## Architecture

### New Package: `internal/output/`

```
internal/output/
  formatter.go      // Formatter interface + factory + TTY detection
  json.go           // JSONFormatter (verdict JSON, current default)
  sarif.go          // SARIFFormatter (GitHub-compliant SARIF)
  markdown.go       // MarkdownFormatter (GFM for PR comments)
  pretty.go         // PrettyFormatter (colored terminal output via lipgloss)
```

### Formatter Interface

```go
// Formatter converts analysis output to a specific format.
type Formatter interface {
    Format(result *AnalysisOutput) ([]byte, error)
}

// AnalysisOutput bundles everything a formatter needs.
type AnalysisOutput struct {
    Verdict  *store.Verdict
    SARIFLog *sarif.Log
    Stats    *analyzer.TieredAnalyzerStats // optional, nil if not collected
}

// NewFormatter returns the formatter for the given format name.
func NewFormatter(format string) (Formatter, error)

// ResolveFormat determines the output format from the --format flag and TTY state.
// If format is empty: returns "pretty" if stdout is a TTY, "json" otherwise.
func ResolveFormat(flagValue string, stdoutIsTTY bool) string
```

### Format Specifications

#### JSON (default when piped)

Current behavior preserved exactly. Outputs `store.Verdict` as indented JSON.

#### SARIF (GitHub Code Scanning compliant)

Post-processing enrichment of the assembled `sarif.Log`:

| Field | Source |
|-------|--------|
| `partialFingerprints.primaryLocationLineHash` | SHA-256 of `ruleID + uri + startLine + message` |
| `result.properties.security-severity` | Mapped from level: error=8.0, warning=5.0, note=2.0 |
| `result.properties.precision` | From `gavel/tier`: comprehensive="high", fast="medium", instant="medium" |
| `invocations[].workingDirectory.uri` | `os.Getwd()` at format time |
| `tool.driver.informationUri` | `"https://github.com/chris-regnier/gavel"` |
| `tool.driver.rules[].properties.tags` | Populated from `gavel/cwe` and `gavel/owasp` result properties |

The `sarif.Log` struct and `Assemble()` function remain untouched. Enrichment happens in the formatter.

#### Markdown (GFM for PR comments)

```markdown
## Gavel Analysis Summary

**Decision:** :warning: Review Required | **Findings:** 5 | **Files:** 3

### Findings by Severity
| Severity | Count |
|----------|-------|
| error    | 1     |
| warning  | 3     |
| note     | 1     |

### Findings

<details>
<summary><strong>error</strong> -- SEC001: Hardcoded secret detected in <code>config/db.go:42</code></summary>

**Rule:** SEC001 -- Hardcoded Credentials
**Confidence:** 0.95
**File:** `config/db.go` lines 42-42

> Hardcoded database password found in configuration file.

**Recommendation:** Use environment variables or a secrets manager.

</details>

---
*Generated by [Gavel](https://github.com/chris-regnier/gavel) -- code-reviewer persona*
```

Design choices:
- `<details>` collapsible sections for large reviews
- Severity emoji: error = :red_circle:, warning = :warning:, note = :information_source:
- Findings sorted by severity (error first), then file path
- Decision banner at top for CI/CD visibility

#### Pretty (colored terminal output)

```
  Gavel Analysis
  ──────────────────────────────────
  Decision: review  |  5 findings  |  3 files
  Persona: code-reviewer

  config/db.go
    42:1  error    SEC001  Hardcoded secret detected        (0.95)
    78:1  warning  ERR003  Error not checked                (0.82)

  internal/handler.go
    15:1  warning  SEC005  SQL string concatenation          (0.88)
    23:1  note     STY001  Function exceeds 50 lines         (0.70)

  cmd/main.go
    9:1   warning  ERR001  Panic in init function            (0.75)

  ──────────────────────────────────
  1 error, 3 warnings, 1 note
```

Design choices:
- Grouped by file, sorted by line within file
- Colors: red=error, yellow=warning, blue/dim=note
- Compact one-line-per-finding with rule ID, message, confidence
- Respects `NO_COLOR` env var (standard)
- Uses lipgloss (already a dependency)

### Structured Logging

Replace all `log.Printf` and diagnostic `fmt.Fprintf(os.Stderr)` calls with `log/slog`.

**Flags (added to root command):**

| Flag | Level | Use case |
|------|-------|----------|
| (default) | `warn` | Only warnings and errors |
| `--verbose` / `-v` | `info` | Progress: "Analyzing file 3/10..." |
| `--debug` | `debug` | Cache hits, tier timings, BAML details |
| `--quiet` / `-q` | disabled | Suppress all logs, data output only |

**Separation principle:**
- **stdout**: Data output only (verdict JSON, SARIF, markdown, pretty text)
- **stderr**: All diagnostic/log output via slog

**Migration targets:**

| Current | New |
|---------|-----|
| `log.Printf("Warning: failed to upload...")` in analyze.go | `slog.Warn("cache upload failed", "err", err)` |
| `fmt.Fprintln(os.Stderr, "Generating policy...")` in create.go | `slog.Info("generating policy")` |
| `log.Printf("Failed to warm local cache...")` in multitier.go | `slog.Warn("cache warm failed", "err", err)` |
| `log.Printf("Error handling message...")` in lsp/server.go | `slog.Error("message handling failed", "err", err)` |

**Not changing:**
- `fmt.Println(content)` in create.go:310 (legitimate data output)
- `fmt.Printf` in version command (data output)

### Changes to `cmd/gavel/analyze.go`

The analyze command's output path simplifies to:

```go
// Resolve format
format := output.ResolveFormat(flagFormat, isatty.IsTerminal(os.Stdout.Fd()))

// Format and write
formatter, _ := output.NewFormatter(format)
data, _ := formatter.Format(&output.AnalysisOutput{
    Verdict:  verdict,
    SARIFLog: sarifLog,
})
os.Stdout.Write(data)
```

New flags on the analyze command:
- `--format` / `-f`: Output format (json, sarif, markdown, pretty)

New flags on the root command:
- `--quiet` / `-q`: Suppress log output
- `--verbose` / `-v`: Verbose log output
- `--debug`: Debug log output

### Dependencies

- `github.com/mattn/go-isatty` — TTY detection (small, well-maintained, widely used)
- `github.com/charmbracelet/lipgloss` — Already in go.mod via review TUI
- `log/slog` — Go stdlib (1.21+)

## Testing Strategy

- Unit tests per formatter with golden file comparisons
- Test TTY resolution logic
- Test SARIF output validates against the SARIF 2.1.0 schema
- Test markdown output renders correctly (string assertions)
- Test pretty output with and without `NO_COLOR`
- Test that slog output goes to stderr, data to stdout (integration test)
