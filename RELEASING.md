# Releasing Gavel

This document describes the release process for Gavel using GoReleaser.

## Prerequisites

- Git repository with GitHub remote configured
- GitHub Personal Access Token with `repo` scope (automatically provided in GitHub Actions)
- GoReleaser installed (for local testing): `go install github.com/goreleaser/goreleaser/v2@latest`

## Automated Release Process

Releases are fully automated via GitHub Actions when you push a git tag:

```bash
# Create and push a new version tag
git tag -a v0.1.0 -m "Release v0.1.0"
git push origin v0.1.0
```

The GitHub Actions workflow (`.github/workflows/release.yml`) will:

1. Checkout the code
2. Set up Go 1.25
3. Install BAML CLI
4. Run GoReleaser, which will:
   - Run `baml-cli generate` (pre-build hook)
   - Run tests (`go test ./...`)
   - Run linter (`go vet ./...`)
   - Build binaries for multiple platforms (Linux, macOS, Windows; amd64 and arm64)
   - Create archives (.tar.gz for Unix, .zip for Windows)
   - Generate checksums
   - Create a GitHub release with auto-generated changelog
   - Upload all artifacts to the release

## Platforms

GoReleaser builds for the following platforms:

| OS      | Architecture | Binary Format |
|---------|-------------|---------------|
| Linux   | amd64       | .tar.gz       |
| Linux   | arm64       | .tar.gz       |
| macOS   | amd64       | .tar.gz       |
| macOS   | arm64       | .tar.gz       |
| Windows | amd64       | .zip          |

## Version Information

GoReleaser injects version information into the binary via ldflags:

```go
var (
    version = "dev"  // Set to git tag
    commit  = "none" // Set to git commit SHA
    date    = "unknown" // Set to build timestamp
)
```

Users can view this with:

```bash
./gavel version
# Output:
# gavel v0.1.0
#   commit: abc1234
#   built at: 2024-01-15T10:30:00Z
```

## Testing Locally

Test the release process without publishing:

```bash
# Validate configuration
goreleaser check

# Build a snapshot (no tag required, won't publish)
goreleaser release --snapshot --clean

# Inspect artifacts
ls -la dist/
```

This creates binaries in `dist/` but doesn't create a GitHub release.

## Changelog

GoReleaser auto-generates a changelog from commit messages using conventional commit prefixes:

| Prefix | Changelog Section |
|--------|------------------|
| `feat:` or `feat(scope):` | New Features |
| `fix:` or `fix(scope):` | Bug Fixes |
| `perf:` or `perf(scope):` | Performance Improvements |
| `refactor:` or `refactor(scope):` | Refactors |
| `docs:` or `docs(scope):` | Documentation |

Commits with `docs:`, `test:`, `chore:`, or merge commits are excluded from the changelog.

## Release Assets

Each release includes:

1. **Binary archives**: `gavel_<version>_<OS>_<arch>.tar.gz` (or .zip)
   - Contains: `gavel` binary, `README.md`, `LICENSE*`
2. **Checksums**: `checksums.txt`
   - SHA256 hashes for all archives
3. **Source code**: Auto-generated by GitHub (`.tar.gz` and `.zip`)

## Version Naming

Follow [Semantic Versioning](https://semver.org/):

- `v0.1.0` - Initial releases
- `v0.1.1` - Patch release (bug fixes)
- `v0.2.0` - Minor release (new features, backward compatible)
- `v1.0.0` - Major release (breaking changes)

Always prefix tags with `v`.

## Troubleshooting

### Release fails with "BAML CLI not found"

The GitHub Actions workflow installs BAML CLI automatically. If it fails, check:
- BAML CLI installation script is accessible
- Network connectivity to download BAML CLI

### "GITHUB_TOKEN" permissions error

Ensure the workflow has `contents: write` permission (already configured in `.github/workflows/release.yml`).

### Tests fail during release

GoReleaser runs tests before building. Fix failing tests before tagging:

```bash
go test ./...
```

### Want to delete a failed release

```bash
# Delete remote tag
git push --delete origin v0.1.0

# Delete local tag
git tag -d v0.1.0

# Delete the GitHub release manually via the web UI
```

Then fix the issue and create a new tag.

## Future Enhancements

Consider adding (commented out in `.goreleaser.yml`):

1. **Homebrew Tap**: Auto-publish to a Homebrew tap for easy installation on macOS
2. **Docker Images**: Build and push multi-arch Docker images to GHCR
3. **APT/RPM Repositories**: Package for Linux distributions
